{% extends 'billing/l2_proformabill_selected.html' %}
{% load bootstrap3 %}
{% load decimal_format %}

{% block title %}Ver Proforma {{ proformabill }} - {{ block.super }}{% endblock %}
{% block body_l1 %}
        <h1>Proforma</h1>
        <table class='table table-hover'>
            <tr>
                <th>Numero</th>
                <td>{{ proformabill.number }}</td>
                <td rowspan='4'>
                    <a href="{% url "proformabill_update" proformabill.id %}" class='btn btn-default'>Editar datos</a>
                </td>
            </tr>
            <tr>
                <th>Cliente</th>
                <td>({{ proformabill.issued_to.tipo_identificacion }}) {{ proformabill.issued_to.identificacion }} </td>
            </tr>
            <tr>
                <th></th>
                <td>{{ proformabill.issued_to.razon_social }}</td>
            </tr>
            <tr>
                <th>Fecha</th>
                <td>{{ proformabill.date }}</td>
            </tr>
        </table>
        <h2>Detalle</h2>
        <a name='detalle_table'></a>
        <table class='table table-hover'>
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Nombre</th>
                    <th>Cantidad</th>
                    <th>Precio unitario</th>
                    <th>Subtotal</th>
                    <th>Impuestos</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id='detail_table'>
                {% include "billing/proformabill_detail_item_table.html" %}
            </tbody>
        </table>
        <div class='container-fluid'>
            <div class='row'>
                <div class="input-group col-xs-12 col-sm-12 col-md-12 col-lg-12" role="group">
                    <span class="input-group-addon" id="basic-addon1"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></span>
                    <input id='search_item' type="text" class="dropdown-toggle form-control col-xs-12 col-sm-12 col-md-12 col-lg-12"
                        placeholder='Añadir Artículo'
                        value=''
                        autofocus />
                    <ul class="dropdown-menu col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    </ul>
                    <noscript>
                    <a href="{% url "proformabill_add_item" proformabill.id %}" class='btn btn-primary col-xs-12 col-sm-12 col-md-4 col-lg-4'>Añadir Artículo</a>
                    </noscript>
                </div>
            </div>
        </div>
        <h2>Totales</h2>
        <table class='table table-hover'>
            <tbody id='totals_table'>
                {% include "billing/proformabill_detail_totals_table.html" %}
            </tbody>
        </table>
        {% buttons %}
            <a href="{% url "proformabill_emit_to_bill" proformabill.id %}" class='btn btn-primary'>Emitir Proforma</a>
            <a href="{% url "proformabill_delete" proformabill.id %}" class='btn btn-danger'>Eliminar</a>
        {% endbuttons %}


<script>
function gen_name(item) {
    return item.sku + " - " + item.name;
}

function reload_content(selector, url) {
    $(selector)
        .animate(
            {opacity: 0},
            400, function() {
            $(selector)
            .load(url, function() {
                $(selector).animate({opacity: 1}, 400);
                location.href = "#detalle_table";
            });
        });
}

function click_callback(item) {
    var token_data = $("{% csrf_token %}");
    var data_to_post = {copy_from: item.id,
                        qty: '1'};
    data_to_post[token_data.attr("name")] = token_data.attr('value');

    $.post('{% url "proformabill_add_item" proformabill.id %}', data_to_post)
        .done(function () {
            reload_content("#detail_table", 
                           "{% url 'proformabill_detail_item_table' proformabill.id %}");
            reload_content("#totals_table", 
                           "{% url 'proformabill_detail_totals_table' proformabill.id %}");
        })
        .fail(function (data) {
            console.log(data);
        });
}

prepare_search_box(
    '#search_item',
    gen_name,
    click_callback,
    '{% url 'item_index_json' company.id %}',
    ['sku', 'name', 'description'],
    "<span style='color: #777'>No se encontró ningún artículo</span>",
    "Error cargando lista");

function handle_qty(ev) {
    var current_value = $(this).html();
    var current_id = $(this).attr('data-id');
    var td = $(this);
    $(this)
        .html("");

    function try_accept(ob) {
        var new_value = $(ob).val();
        var test_str = td.attr('data-check-fun') + "(" + new_value + ")";
        var test = eval(test_str);
        if(test) {
            //alert(current_value); FIXME: submit and reload
            td.html(new_value);
            td.one("click", handle_qty);
        } else {
            td.html(current_value);
            td.one("click", handle_qty);
        }
    }

    $(this)
        .append(
            $("<input>").attr("type", "text")
                        .attr("value", current_value)
                        .blur(function (ev) {
                            try_accept(this);
                        })
                        .on("keypress", function(ev) {
                            if(ev.which == 13) {
                                try_accept(this);
                            }
                        })
        );
    var input = td.find("input");
    input.focus();
    input.val("");
    input.val(current_value);
    

    $("h2").on("click", function () {
        $(".item_qty[data-id=" + current_id + "]").one("click", handle_qty);
    });
}
$(".item_qty").one("click", handle_qty);
</script>

{% endblock %}
